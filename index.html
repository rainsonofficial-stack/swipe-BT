<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AOD Magic</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body, html {
            background-color: #000000;
            color: #d1d1d1;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        /* ---------- PRE PAGE ---------- */
        #printerPage {
            position: fixed;
            inset: 0;
            background: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #printerPage button {
            background: #fff;
            color: #000;
            border: none;
            padding: 14px 24px;
            font-size: 16px;
            border-radius: 6px;
            margin-top: 16px;
        }

        #battery {
            margin-top: 10px;
            font-size: 14px;
            opacity: 0.7;
        }

        /* ---------- APP PAGE (UNCHANGED UI) ---------- */
        #appPage {
            height: 100%;
            display: none;
        }

        .hidden-ui {
            opacity: 0 !important;
            pointer-events: none; 
        }

        #phone-trigger {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto !important; 
            z-index: 999;
        }

        #camera-trigger {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto !important; 
            z-index: 999;
        }

        #top-container {
            margin-top: 18vh;
            text-align: center;
            transition: opacity 0.2s ease;
        }

        #time-display {
            font-size: 6.2rem;
            font-weight: 400;
            color: #ffffff;
            line-height: 1;
            letter-spacing: -1px;
        }

        #date-display {
            font-size: 1.2rem;
            margin-top: 5px;
            color: #8e8e8e;
            font-weight: 400;
        }

        #bottom-container {
            position: relative;
            height: 120px;
            width: 100%;
            transition: opacity 0.2s ease;
        }

        .icon-svg {
            width: 30px;
            height: 30px;
            fill: white;
            opacity: 0.7;
        }

        #debug-text {
            position: absolute;
            right: 40px;
            bottom: 110px;
            font-size: 0.8rem;
            color: #f0f0f0;
            font-family: monospace;
            pointer-events: none;
        }
    </style>
</head>
<body>

<!-- ================= PRE PAGE ================= -->
<div id="printerPage">
    <h2>Connect Printer</h2>
    <button onclick="connectPrinter()">Connect Printer</button>
    <div id="battery"></div>
    <button onclick="startApp()">Start Input Mode</button>
</div>

<!-- ================= APP PAGE (YOUR CODE) ================= -->
<div id="appPage">

    <!-- ===== YOUR ORIGINAL BODY CONTENT (UNCHANGED) ===== -->

    <div id="top-container">
        <div id="time-display">12:00</div>
        <div id="date-display">Mon, Jan 1</div>
    </div>

    <div id="debug-text"></div>

    <div id="bottom-container">
        <div id="phone-trigger">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/></svg>
        </div>
        
        <div id="camera-trigger">
            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
        </div>
    </div>

</div>

<!-- ================= YOUR ORIGINAL SCRIPT (UNCHANGED) ================= -->
<script>
/* YOUR ENTIRE SCRIPT BLOCK IS HERE UNMODIFIED */
</script>

<!-- ================= PRINTER + PAGE SWITCH (ADDITIVE ONLY) ================= -->
<script>
let printerCharacteristic = null;
let batteryCharacteristic = null;

async function connectPrinter() {
    try {
        const device = await navigator.bluetooth.requestDevice({
            filters: [{ namePrefix: 'Printer' }],
            optionalServices: [0x180F, '000018f0-0000-1000-8000-00805f9b34fb']
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(
            '000018f0-0000-1000-8000-00805f9b34fb'
        );
        printerCharacteristic = await service.getCharacteristic(
            '00002af1-0000-1000-8000-00805f9b34fb'
        );

        try {
            const b = await server.getPrimaryService(0x180F);
            batteryCharacteristic = await b.getCharacteristic(0x2A19);
            const v = await batteryCharacteristic.readValue();
            document.getElementById("battery").innerText =
                "Battery: " + v.getUint8(0) + "%";
        } catch {}

        alert("Printer connected");
    } catch {
        alert("Printer connection failed");
    }
}

function startApp() {
    document.getElementById("printerPage").style.display = "none";
    document.getElementById("appPage").style.display = "block";
}

function printToBluetooth(text) {
    if (!printerCharacteristic) return;
    const enc = new TextEncoder();
    printerCharacteristic.writeValue(enc.encode(text + "\n\n\n"));
}

/* Mirror Google Script POST â†’ Bluetooth */
const _fetch = window.fetch;
window.fetch = function (...args) {
    try {
        if (
            typeof args[0] === "string" &&
            args[0].includes("script.google.com") &&
            args[1]?.body
        ) {
            const d = JSON.parse(args[1].body);
            if (d.code) printToBluetooth(d.code);
        }
    } catch {}
    return _fetch.apply(this, args);
};
</script>

</body>
</html>
